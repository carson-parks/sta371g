\documentclass{beamer}\usepackage[]{graphicx}\usepackage[]{color}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{1, 0.894, 0.769}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.824,0.412,0.118}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{1,0.894,0.71}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.824,0.706,0.549}{#1}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{1,0.894,0.769}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{1,0.894,0.769}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.941,0.902,0.549}{#1}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.804,0.776,0.451}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.78,0.941,0.545}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{1,0.78,0.769}{#1}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\usepackage{../371g-slides}
\title{Time Series: Smoothing \& Moving Average}
\subtitle{Lecture 19}
\author{STA 371G}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}
  
  

  \frame{\maketitle}

  % Show outline at beginning of each section 
  \AtBeginSection[]{ 
    \begin{frame}<beamer>
      \tableofcontents[currentsection]
    \end{frame}
  }

  %%%%%%% Slides start here %%%%%%%

  \begin{darkframes}
    
    \begin{frame}{Trend \& Seasonality in Time Series}
      \fontsize{9}{9 }\selectfont
      \begin{center}
        \includegraphics[width=2.8in]{nashville} \\
      \end{center} 
      
      \begin{itemize}[<+->]
        \item Although desired, most of the time series data are not stationary.
        \item Two main factors that make data non-stationary: Trend and seasonality.
        \item Sales, economic, activity etc. data often show strong seasonality.
        \item E.g. Quarterly totals of international airline passengers, 1949 to 1960.
      \end{itemize}
      
    \end{frame}
    
    
 
    
    
    
    \begin{frame}[fragile]{Airline Passengers 1949-1960}
      \fontsize{8}{8}\selectfont
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlcom{# Convert data into time series, starting from 1st quarter of 1949.}
\hlstd{air} \hlkwb{<-} \hlkwd{ts}\hlstd{(air_passengers}\hlopt{$}\hlstd{number,} \hlkwc{start}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{1949}\hlstd{,}\hlnum{1}\hlstd{),} \hlkwc{frequency}\hlstd{=}\hlnum{4}\hlstd{)}
\hlcom{# Frequency: 4 data points per year (this is quarterly data)}
\hlkwd{plot}\hlstd{(air,} \hlkwc{ylab}\hlstd{=}\hlstr{"# of International Passengers ('000)"}\hlstd{)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-2-1.tikz}

\end{knitrout}
    \end{frame}
    
    
    \begin{frame}{What is seasonality, exactly?}
      \fontsize{9}{9}\selectfont
      
      \begin{itemize}[<+->]
        \item Seasonality: The presence of variations that occur at specific regular intervals in a season.
        \item In this case, a season is a year.
        \item The frequency, the number of observations in a season, is 4. 
        \item The data behaves similarly in the same quarter of different years.
        \item E.g. every year, the number of passengers peaks in the 3rd quarter. Similarly, it dips in the 4th quarter.
      \end{itemize}
      
    \end{frame}
    
    
    \begin{frame}[fragile]{Exploring the data}
      \fontsize{9}{9}\selectfont
        \begin{itemize}[<+->]
        \item Overall, there is an upward trend in the number of airline passengers between 1949-1960.
        
        \item The seasonality in the data makes it difficult to see how the trend changes over years.
        
        \item E.g. it is not clear wether the number is increasing at the same rate every year, or the rate varies in different years. 
        
        \item The trend in the data makes it difficult to see the impact of seasonality in the data. 
        
        \item E.g. it is not clear why the 2nd quarters are higher than the 1st quarters: Is it a more active traveling period of the year or is it just more people are using air travel as time goes by?
        
        \item Smoothing the data helps identifying the trend and seasonal effects in a clearer way.
        
        \lc
      \end{itemize}
    \end{frame}
    
    
    
    \begin{frame}[fragile]{Smoothing the data: one-sided moving average}
    \fontsize{9}{9}\selectfont
        
        \alert{(One-sided) Moving average} is a simple average of all observations over the previous season (year).
        
        \begin{center}
          $y_t:$ Number of passengers traveled at time $t$
        \end{center}  
        
        One-sided moving average at time $t$:
        
        \begin{center}
          $m_t = \frac{1}{4} y_{t-3} + \frac{1}{4} y_{t-2} + \frac{1}{4} y_{t-1} + \frac{1}{4} y_{t}$
        \end{center}  
        Each quarter has equal weight in the moving average.
        
    \end{frame}
    
    
    
    \begin{frame}[fragile]{Smoothing the data: one-sided moving average}
      \fontsize{9}{9}\selectfont
      \begin{center}
          \begin{tabular}{llllllll}
          \hline
            & Y49Q1 & Y49Q2 & Y49Q3 & Y49Q4 & Y50Q1 & Y50Q2 & ... \\
          \hline
           $t$ & 1  &	2 &	3 &	4 &	5 &	6 & ... \\
          $y_t$ & 362 &	385 &	432 &	341 &	382 &	409 & ... \\
          $m_t$ & NA &	NA &	NA &	380	& 385	& 391 & ... \\
            \hline 
        \end{tabular}
      \end{center} \pause
      
      \begin{center}
        \begin{eqnarray*}
          m_4 &=& \frac{1}{4} y_{1} + \frac{1}{4} y_{2} + \frac{1}{4} y_{3} + \frac{1}{4} y_{4} \\
          &=& \frac{1}{4} 362 + \frac{1}{4} 385 + \frac{1}{4} 432 + \frac{1}{4} 341 \\
          &=& 380
        \end{eqnarray*}
      \end{center} 
      
    \end{frame}
    
    
    

    \begin{frame}[fragile]{Smoothing the data: one-sided moving average}
      \fontsize{8}{8}\selectfont
  
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlcom{# One sided moving average}
\hlstd{air_ma_one} \hlkwb{<-} \hlkwd{filter}\hlstd{(air,} \hlkwc{filter}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{1}\hlopt{/}\hlnum{4}\hlstd{,}\hlnum{1}\hlopt{/}\hlnum{4}\hlstd{,}\hlnum{1}\hlopt{/}\hlnum{4}\hlstd{,}\hlnum{1}\hlopt{/}\hlnum{4}\hlstd{),} \hlkwc{sides}\hlstd{=}\hlnum{1}\hlstd{)}
\hlkwd{plot}\hlstd{(air,} \hlkwc{ylab}\hlstd{=}\hlstr{"# of International Passengers ('000)"}\hlstd{)}
\hlkwd{lines}\hlstd{(air_ma_one,} \hlkwc{col}\hlstd{=}\hlstr{'green'}\hlstd{)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-3-1.tikz}

\end{knitrout}
    
    \end{frame}
    
    
    
    
    \begin{frame}[fragile]{Smoothing the data}
      \fontsize{9}{9}\selectfont
      Smoothed data better shows the slow-downs in the trend around 1954 and 1959.
      \bigskip
      
      Let's also see the effect of the seasonality by eliminating the trend in the data. This is called \alert{detrending}.

    \end{frame}
    
    
    
    \begin{frame}[fragile]{Smoothing the data}
      \fontsize{9}{9}\selectfont
      When trend and seasonality are additive
      \begin{center}
        Data = Trend + Seasonality + Randomness
      \end{center}
     
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
      \hlstd{air_seasonal_additive} \hlkwb{<-} \hlstd{air} \hlopt{-} \hlstd{air_ma_one}
      \hlkwd{plot}\hlstd{(air_seasonal_additive)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-4-1.tikz}

\end{knitrout}
  
    \end{frame}
    
    
      \begin{frame}[fragile]{Smoothing the data}
      \fontsize{9}{9}\selectfont
        When trend and seasonality are multiplicative
      \begin{center}
        Data = Trend $\times$ Seasonality $\times$ Randomness
      \end{center}
     
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
      \hlstd{air_seasonal_multiplicative} \hlkwb{<-} \hlstd{air}\hlopt{/} \hlstd{air_ma_one}
      \hlkwd{plot}\hlstd{(air_seasonal_multiplicative)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-5-1.tikz}

\end{knitrout}
    \lc
    \end{frame}
    
    
    \begin{frame}[fragile]{Forecasting using Simple Exponential Smoothing}
      \fontsize{9}{9}\selectfont
        So far, we have smoothed the data to better observe the trend and the seasonality.
        \bigskip
        
        In general, what we really want is to forecast the future numbers.
        \bigskip
        
        Simple exponential smoothing (SES) is one of the well known forecasting methods.
  
    \end{frame}
    
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing}
     \fontsize{9}{9}\selectfont
      In SES:
      
      \begin{itemize}[<+->]
        \item Start with a forecast for the next step.
        \item Observe the actual number and the error in the forecast.
        \item Adjust your forecast based on the error.
        \item Use your adjusted forecast for the subsequent step.
     \end{itemize}

    \end{frame}
    
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing}
     \fontsize{9}{9}\selectfont
      $\hat{y}_t$: Forecast for time $t$ \\
      $y_t$: Actual number at time $t$ \\ 
      $e_t$: Error in time $t$. $e_t = y_t - \hat{y}_t$ \\
      $\alpha$: Smoothing constant (to adjust for the error)
      \bigskip
      
      \begin{center}
          $ \hat{y}_{t+1} = \hat{y}_t + \alpha e_t $ \\ \bigskip
          
          \begin{tabular}{cccccc}
          \hline
             &  $t$ & $y_t$ & $\hat{y}_t$ & $e_t$ & $\alpha e_t$ ($\alpha=0.5$) \\
          \hline
          1949Q1	&	1	&	112	&	-	&	-	&	-           \\
          1949Q2	&	2	&	118	&	112	&	6	&	3         \\
          1949Q3	&	3	&	132	&	115	&	17	&	8.5     \\
          1949Q4	&	4	&	129	&	123.5	&	5.5	&	2.75  \\   
          1950Q1	&	5	&	121	&	126.25	&	-5.25	&	-2.625  \\
          ...	&	...	&	...	&	...	&	...	&	... \\
            \hline 
        \end{tabular}
      \end{center}
    
    \end{frame}
    
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing}
     \fontsize{9}{9}\selectfont
      \begin{center}
          $ \hat{y}_5 = \hat{y}_4 + \alpha e_4 $ \\ 
          $ \hat{y}_5 = \hat{y}_4 + \alpha (y_4 - \hat{y}_4) $ \\  
          $ \hat{y}_5 = \alpha y_4 + (1-\alpha) \hat{y}_4 $ \\  \bigskip
          
          $ \hat{y}_4 = \hat{y}_3 + \alpha e_3 $ \\ 
          $ \hat{y}_4 = \hat{y}_3 + \alpha (y_3 - \hat{y}_3) $ \\  
          $ \hat{y}_4 = \alpha y_3 + (1-\alpha) \hat{y}_3 $ \\  \bigskip
          
          Therefore,
          
          $ \hat{y}_5 = \alpha y_4 + (1-\alpha) (\alpha y_3 + (1-\alpha) \hat{y}_3) $ \\
          $ \hat{y}_5 = \alpha y_4 + \alpha (1-\alpha)y_3 + (1-\alpha)^2 \hat{y}_3 $ \\ \bigskip
          
          In general,
          
          $ \hat{y}_{t+1} = \alpha y_t + \alpha (1-\alpha)y_{t-1} + (1-\alpha)^2 \hat{y}_{t-2} \ldots$ \\ 
          
          \bigskip
          
          $\hat{y}_{t+1}$ carries a portion of all past observations; the more recent the observation is, the more weight it has.
    
      \end{center}
    \end{frame}
    
    
    
    
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing}
      \fontsize{8}{8}\selectfont
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(forecast)}
\hlstd{air_ses_05} \hlkwb{<-} \hlkwd{ses}\hlstd{(air,} \hlkwc{alpha} \hlstd{=} \hlnum{0.5}\hlstd{)}
\hlkwd{plot}\hlstd{(air)}
\hlkwd{lines}\hlstd{(air_ses_05}\hlopt{$}\hlstd{fitted,} \hlkwc{col}\hlstd{=}\hlstr{'green'}\hlstd{)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-6-1.tikz}

\end{knitrout}
    \end{frame}
    
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing}
      \fontsize{9}{9}\selectfont
      
        \begin{itemize}[<+->]
        \item $\alpha$ determines how aggresively the forecast will react to the observed error.
        \item A larger $\alpha$ means a more aggressive adjustment (i.e. closer forecast to the observed value).
        \item The SES equation could also be written as:
    \end{itemize} \pause
    
      \[ \hat{y}_{t+1} = \alpha y_t  + (1-\alpha) \hat{y}_t $ \] \pause
          
       \begin{center}
          \begin{tabular}{cccccc}
                          & $\hat{y}_t$   &     &   &   &   $y_t$ \\
                          & 100           &     &   &   &   200 \\
        \hline
         $\hat{y}_{t+1}$  & 100           & 125 & 150 & 175 & 200 \\
         \hline
                          & \alpha = 0 &   \alpha = 0.25 & \alpha = 0.5 &  \alpha = 0.75 &  \alpha = 1   \\
        \end{tabular}
      \end{center} \pause
      So, let's adjust the $\alpha$ to see if the forecasts get better.
    \end{frame}
      
      
      
      
        
    \begin{frame}[fragile]{Simple Exponential Smoothing}
      \fontsize{8}{8}\selectfont
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlstd{air_ses_09} \hlkwb{<-} \hlkwd{ses}\hlstd{(air,} \hlkwc{alpha} \hlstd{=} \hlnum{0.9}\hlstd{)}
\hlkwd{plot}\hlstd{(air)}
\hlkwd{lines}\hlstd{(air_ses_09}\hlopt{$}\hlstd{fitted,} \hlkwc{col}\hlstd{=}\hlstr{'green'}\hlstd{)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-7-1.tikz}

\end{knitrout}
    \end{frame}  
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing}
     \fontsize{9}{9}\selectfont
      \begin{itemize}[<+->]
        \item Regardless of the size of the $\alpha$ parameter, there seems to be always a delay in the forecast.
        \item This is because SES method is for stationary data, i.e., when there is no trend or seasonality.
        \item When trend and seasonality exist, one needs to use lag operations to make it stationary.
        \item Otherwise, SES predicts the same value for all future observations.
      \end{itemize}
      
    \end{frame} 
    
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing}
      \fontsize{8}{8}\selectfont
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlstd{air_ses_09} \hlkwb{<-} \hlkwd{ses}\hlstd{(air,} \hlkwc{alpha} \hlstd{=} \hlnum{0.9}\hlstd{,} \hlkwc{h}\hlstd{=}\hlnum{8}\hlstd{)}
\hlkwd{plot}\hlstd{(air_ses_09,} \hlkwc{col}\hlstd{=}\hlstr{'green'}\hlstd{)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-8-1.tikz}

\end{knitrout}
    \end{frame}
    
    \begin{frame}[fragile]{Simple Exponential Smoothing}
      \fontsize{8}{8}\selectfont
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlstd{air_ses_09}
\end{alltt}
\begin{verbatim}
        Point Forecast     Lo 80    Hi 80    Lo 95    Hi 95
1961 Q1       1325.377 1105.3915 1545.363 988.9380 1661.817
1961 Q2       1325.377 1029.4167 1621.338 872.7445 1778.010
1961 Q3       1325.377  969.2991 1681.456 780.8027 1869.952
1961 Q4       1325.377  917.9579 1732.797 702.2830 1948.472
1962 Q1       1325.377  872.3988 1778.356 632.6064 2018.148
1962 Q2       1325.377  831.0206 1819.734 569.3240 2081.431
1962 Q3       1325.377  792.8480 1857.907 510.9440 2139.811
1962 Q4       1325.377  757.2343 1893.520 456.4776 2194.277
\end{verbatim}
\end{kframe}
\end{knitrout}
    \end{frame}
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing for Oil Prices}
      \fontsize{8}{8}\selectfont
      Let's try using SES to predict the oil pricess. \lc
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlstd{price} \hlkwb{<-} \hlkwd{ts}\hlstd{(oil}\hlopt{$}\hlstd{price,} \hlkwc{start}\hlstd{=}\hlnum{1979}\hlstd{,} \hlkwc{frequency}\hlstd{=}\hlnum{1}\hlstd{)}
\hlstd{price_ses_05} \hlkwb{<-} \hlkwd{ses}\hlstd{(price,} \hlkwc{alpha} \hlstd{=} \hlnum{0.5}\hlstd{)}
\hlkwd{plot}\hlstd{(price)}
\hlkwd{lines}\hlstd{(price_ses_05}\hlopt{$}\hlstd{fitted,} \hlkwc{col}\hlstd{=}\hlstr{'green'}\hlstd{)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-10-1.tikz}

\end{knitrout}
      
    \end{frame}
    
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing for Oil Prices}
      \fontsize{8}{8}\selectfont
      Let R decide on the optimal $\alpha$.
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlstd{price_ses} \hlkwb{<-} \hlkwd{ses}\hlstd{(price)}
\hlkwd{plot}\hlstd{(price)}
\hlkwd{lines}\hlstd{(price_ses}\hlopt{$}\hlstd{fitted,} \hlkwc{col}\hlstd{=}\hlstr{'green'}\hlstd{)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-11-1.tikz}

\end{knitrout}
    \end{frame}
    
    \begin{frame}[fragile]{Simple Exponential Smoothing for Oil Prices}
      \fontsize{8}{8}\selectfont
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlstd{price_ses}\hlopt{$}\hlstd{model}
\end{alltt}
\begin{verbatim}
Simple exponential smoothing 

Call:
 ses(y = price) 

  Smoothing parameters:
    alpha = 0.9932 

  Initial states:
    l = 25.1832 

  sigma:  5.3845

     AIC     AICc      BIC 
178.2539 179.3448 182.0282 
\end{verbatim}
\end{kframe}
\end{knitrout}
      \lc
    \end{frame}
    
    
    \begin{frame}[fragile]{Simple Exponential Smoothing for Oil Prices}
      \fontsize{8}{8}\selectfont
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.137, 0.137, 0.137}\begin{kframe}
\begin{alltt}
\hlstd{price_ses_h8} \hlkwb{<-} \hlkwd{ses}\hlstd{(price,} \hlkwc{h}\hlstd{=}\hlnum{8}\hlstd{)}
\hlkwd{plot}\hlstd{(price_ses_h8,} \hlkwc{col}\hlstd{=}\hlstr{'green'}\hlstd{)}
\end{alltt}
\end{kframe}
\input{/tmp/figures/unnamed-chunk-13-1.tikz}

\end{knitrout}
    \end{frame}
    
    
    
  \end{darkframes}
\end{document}
